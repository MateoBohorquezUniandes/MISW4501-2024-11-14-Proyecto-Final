name: Build and Deploy to GKE

on:
  push:
    branches:
      - feat/worlflow-deploy
      - 'release/autenticador**'

env:
  PROJECT_SA_KEY: ew0KICAidHlwZSI6ICJzZXJ2aWNlX2FjY291bnQiLA0KICAicHJvamVjdF9pZCI6ICJwcm95ZWN0by1maW5hbC00MTYxMjMiLA0KICAicHJpdmF0ZV9rZXlfaWQiOiAiYWRkMGM0ZjBiMWEzMjYyZWE1MmI3NWRhMGVlZTJkOTg0NGUyZDU2MiIsDQogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQ3NwV1BMYkhHdkVEVU1cbjFhWkozTHNReHpFTUNWbFNQTmkzWEVoYXpDU0ZGRDVySkZvSjJSa2VkdUpOVGI5QmFpLy9uV1ltY2VQd3g2UEtcblozMmcrVmpFcU0vUFRxSDRIQWdGZWgxUnVMVEVObHVOVDJFdFAxMFFMTGE1OWhkMVlORHp1cjdQK0l5V0dkM3dcbjZBUjRBbHJoZERGMnF3THE3T0VJMUxjajRPdnVOOVltKzJPNFpQZlFGQzFJcCtwRXZyWDRjbG9CS3ozS2VwaGNcblJMeTQ1dEQ3RkhtUnNSSFJSV3lnalptckpHdkwyR2JjQ01hVVdDWjVVMnJ2VDduVDF1bENSeVpxZkxzcWlxYVJcblFub3FjeXBkTHE3MG5US2U1djR5ajBEeGlzQUhEUEhVOWJIZDZGdnpFUVl2VjdiNzhyaThmaHZHbCt2YjUrLzdcbmhrV3VMUlNGQWdNQkFBRUNnZ0VBQzVOZjlienFMRytTUWErTGpEL3hYUHZMYXBWYWpmeUlHQUhuS2d0WkFZRkNcbkpDTkEvdVcxc2tpM1Uxdm5VSEZZWnQ1U0FlUTRxOUFVUjljWTRja0dMaWdXeUQxclRSR1lGTUh1SXY0VzcyR29cbi9DTVA1QjJhVmFJaDNhWEY4ZUtteFVqR3BYYkgrbGZML1VIdWxzWUFVUENJKzlOck05UTVJY05JR2tRK1NCcGpcbkR5NTNEQ0tPUDJLcCs3clVMMFpKejRPazJaTWRzZ2E5Z0FtdGU3T2toSHdNek9qdnJ1eTVURWRCV082QUFZRWZcbm8yRkprUlNjK0l5RC80SlJqWStVSVNtYk5BTnNDTTNTMnlDa2FTemQxN1lLYisxdGVVeVdlNk9pUlVFSmNnSlhcbkJyS2lFOWc2ZDZHUlFpQ3cvbnd6NTg3SUxCZDA3c2QwY2RzQmZ5MDRTd0tCZ1FEZzJ3VzZGTHFkWnl6RUFkeTJcbkkxWWswaExBNVNzNTQ5Zmh2WVhsZUpNT051YjVtSlpNRVllR1VCM3F3K2RvUENHUGM3U0pwK0JLKy8yUzFvTnZcbnRhSkN3c20vOHp1UHh0NWtBTzJKUlQyOHNhajZTVkMveDE4OXJGK1daa0RiK3diYTBqb2plRmtSZnJ3ayt4cEtcbnNvSVZldzFMZzdJRzNxVWV6dzU1czdVdHh3S0JnUURFanh5SmlHSnQ4dzBRWHFSeWFjSVJQbkpnQ0NveXo0S3dcblVsYUwwcEhMUHN5bG84OHFpNVgvcUNIbzVpUHE2R2YxeDVzNjBJMDNUbDZlZktldUI1TDE4SW1haUdLWkFwQTFcbmEyVktSbjZ3S0pLTEVIYXhNZXppRHZaQjFIa2xqbnp2c1gybVVEZ1doay9xS2lLSi81aEtGRzh4Y2QzaDZFRmxcblo4N0VTWXJiVXdLQmdRRFh5MXREcW9FdWJzWlhsakhyMngzaFdIc0hCT2puTmZNSmdvbnVJRG1CZXM5UTIwL2lcbjBTL3ZoeFF2S3JQN0pUcFFJZ3N4MFJ0QTIzWVFaaTdlRnNNU3J6NVFLVzhRSFJ0eGZqSjVleW8wM1l2K0tENkdcbnp5Qm9YL1djc2FXdGVNeXJWUGJXODdrSFFVbnZjODFYd3RsMUpCTXVWY1dWTWpmbHlYRnErenoySVFLQmdGUWVcblp2a1k2LzdmNkhSYi9JYVdhaDVWR2orczN0cFY0amt4VTZhTkhDWGVIMWkzN1AzcE5PMXZkK3VqS2pYcTlpckNcbkhOV2owUHVkUjNNT0ovaWJkekpYbVp3UHlCcHhkV1BYTFVjSE9rcUxZb092TFF5U01DMWlkOU1lYWlZL2Y0cFlcbjdFd1R3cDBwSitRdjJnNHkyMnJBcWdHQUdKUUlnSXcwUzlISEkyelBBb0dCQUpvTU5sMVora2sxRi93L0ZIWXJcbmVhWU1CTW15dUxMVHhiNzh1TXh5T0hsWTJwZjBWejcxRWIzeUFmUHpGZlhmbzJ1SytEWVJVSVp5NjRGd0gvZHhcbnhUVnEwdmMrL1ozdVhtWVd4Y2F2ZHBFWG1IcUdKKzN5ZTdiS1NHRXNCaytUYlhnMk91eXhrMzFCYnVVZDQ5TGhcbkhnbjR5dGIrUGZaYnpOMm1HaFBoL2VEaFxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwNCiAgImNsaWVudF9lbWFpbCI6ICJnYS1hY2NvdW50QHByb3llY3RvLWZpbmFsLTQxNjEyMy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsDQogICJjbGllbnRfaWQiOiAiMTA1NjU5MzQ0NTAxMDA0NTQ0MDc1IiwNCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwNCiAgInRva2VuX3VyaSI6ICJodHRwczovL29hdXRoMi5nb29nbGVhcGlzLmNvbS90b2tlbiIsDQogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwNCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvZ2EtYWNjb3VudCU0MHByb3llY3RvLWZpbmFsLTQxNjEyMy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsDQogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iDQp9
  PROJECT_ID: proyecto-final-416123
  GKE_CLUSTER: proyecto-final-cluster   # Add your cluster name here.
  GKE_ZONE: us-central1-a   # Add your cluster zone here.
  DEPLOYMENT_NAME: deploy-auth # Add your deployment name here.
  IMAGE: autenticador

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # Setup gcloud CLI
    - uses: google-github-actions/setup-gcloud@1bee7de035d65ec5da40a31f8589e240eba8fde5
      with:
        service_account_key: ${{ env.PROJECT_SA_KEY }}
        project_id: ${{ env.PROJECT_ID }}

    # Configure Docker to use the gcloud command-line tool as a credential
    # helper for authentication
    - run: |-
        gcloud --quiet auth configure-docker

    # Get the GKE credentials so we can deploy to the cluster
    - uses: google-github-actions/get-gke-credentials@db150f2cc60d1716e61922b832eae71d2a45938f
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}
        credentials: ${{ env.PROJECT_SA_KEY }}

    # Build the Docker image
    - name: Build
      run: |-
        docker build \
          --tag "gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA" \
          --build-arg GITHUB_SHA="$GITHUB_SHA" \
          --build-arg GITHUB_REF="$GITHUB_REF" \
          .

    # Push the Docker image to Google Container Registry
    - name: Publish
      run: |-
        docker push "gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA"

    # Set up kustomize
    - name: Set up Kustomize
      run: |-
        curl -sfLo kustomize https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64
        chmod u+x ./kustomize

    # Deploy the Docker image to the GKE cluster
    - name: Deploy
      run: |-
        ./kustomize edit set image gcr.io/PROJECT_ID/IMAGE:TAG=gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA
        ./kustomize build . | kubectl apply -f -
        kubectl rollout status deployment/$DEPLOYMENT_NAME
        kubectl get services -o wide
